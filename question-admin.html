<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¬¸ì œ ê´€ë¦¬ ì‹œìŠ¤í…œ - ì™„ì „íŒ (CSV ì—…ë¡œë“œ + ì¼ê´„ ì‚­ì œ)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { color: #667eea; font-size: 2.5em; }
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .panel {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        .panel h2 { color: #667eea; margin-bottom: 20px; font-size: 1.8em; }
        
        /* ì¼ê´„ ì„ íƒ ë„êµ¬ ë°” */
        .bulk-actions-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        .bulk-actions-bar .selection-info { font-size: 1.1em; font-weight: bold; }
        .bulk-actions-bar .actions { display: flex; gap: 10px; }
        .bulk-btn {
            padding: 8px 20px;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .bulk-btn:hover { background: white; color: #667eea; }
        .bulk-btn-danger { border-color: #ff4444; background: #ff4444; }
        .bulk-btn-danger:hover { background: #cc0000; border-color: #cc0000; color: white; }
        
        .questions-grid { display: grid; gap: 20px; }
        .question-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid #667eea;
            position: relative;
            transition: all 0.3s;
        }
        .question-card.selected {
            background: #e3f2fd;
            border-left-color: #2196f3;
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
        }
        .question-card.disabled { opacity: 0.5; border-left-color: #999; }
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        .question-header-left { display: flex; align-items: center; gap: 15px; }
        .question-checkbox { width: 24px; height: 24px; cursor: pointer; }
        .question-id {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: bold;
        }
        .question-actions { display: flex; gap: 10px; }
        .action-btn {
            padding: 5px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        .edit-btn { background: #ffc107; color: #000; }
        .delete-btn { background: #dc3545; color: white; }
        .toggle-btn { background: #28a745; color: white; }
        .question-text {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 10px;
            margin-left: 39px;
        }
        .question-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 10px;
            margin-left: 39px;
        }
        .meta-badge { padding: 5px 10px; border-radius: 5px; font-size: 0.9em; }
        .difficulty-easy { background: #d4edda; color: #155724; }
        .difficulty-medium { background: #fff3cd; color: #856404; }
        .difficulty-hard { background: #f8d7da; color: #721c24; }
        .stats-badge { background: #e7f3ff; color: #004085; }
        
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: bold;
            display: none;
            animation: slideIn 0.3s;
        }
        .alert.show { display: block; }
        .alert-success { background: #d4edda; color: #155724; border: 2px solid #28a745; }
        .alert-danger { background: #f8d7da; color: #721c24; border: 2px solid #dc3545; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .category-tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .category-tab {
            padding: 10px 20px;
            background: #e9ecef;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
        }
        .category-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .category-tab:hover { transform: translateY(-2px); }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            overflow-y: auto;
        }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-content h2 { color: #667eea; margin-bottom: 20px; }
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 2em;
            cursor: pointer;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“š ë¬¸ì œ ê´€ë¦¬ ì‹œìŠ¤í…œ (ì™„ì „íŒ)</h1>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="openCsvModal()">ğŸ“‚ CSVë¡œ ì¼ê´„ ì—…ë¡œë“œ</button>
            </div>
        </div>

        <div id="success-message" class="alert alert-success"></div>
        <div id="error-message" class="alert alert-danger"></div>

        <div class="panel">
            <h2>ë¬¸ì œ ëª©ë¡</h2>

            <div class="category-tabs">
                <button class="category-tab active" onclick="filterByCategory('all')">ì „ì²´</button>
                <button class="category-tab" onclick="filterByCategory('datatypes')">ìë£Œí˜•</button>
                <button class="category-tab" onclick="filterByCategory('numpy')">Numpy</button>
                <button class="category-tab" onclick="filterByCategory('pandas')">Pandas</button>
                <button class="category-tab" onclick="filterByCategory('data_loading')">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button class="category-tab" onclick="filterByCategory('operations')">ì—°ì‚°</button>
            </div>

            <div class="bulk-actions-bar">
                <div class="selection-info">
                    <span id="selected-count">0</span>ê°œ ë¬¸ì œ ì„ íƒë¨
                </div>
                <div class="actions">
                    <button class="bulk-btn" onclick="selectAll()">âœ… ì „ì²´ ì„ íƒ</button>
                    <button class="bulk-btn" onclick="deselectAll()">âŒ ì„ íƒ í•´ì œ</button>
                    <button class="bulk-btn bulk-btn-danger" onclick="confirmBulkDelete()">ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ</button>
                </div>
            </div>

            <div class="questions-grid" id="questions-list">
                <p style="text-align: center; color: #666; padding: 40px;">
                    Firebaseì—ì„œ ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </p>
            </div>
        </div>
    </div>

    <!-- CSV ì—…ë¡œë“œ ëª¨ë‹¬ -->
    <div id="csv-modal" class="modal">
        <div class="modal-content" style="position: relative;">
            <span class="close-btn" onclick="closeCsvModal()">&times;</span>
            <h2>ğŸ“‚ CSVë¡œ ì¼ê´„ ì—…ë¡œë“œ</h2>
            
            <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <p style="margin-bottom: 10px;"><strong>âš ï¸ CSV íŒŒì¼ í˜•ì‹:</strong></p>
                <ol style="margin-left: 20px; line-height: 1.8;">
                    <li><strong>category</strong> - ì¹´í…Œê³ ë¦¬ (datatypes, numpy, pandas, data_loading, operations)</li>
                    <li><strong>question</strong> - ë¬¸ì œ ë‚´ìš©</li>
                    <li><strong>example</strong> - ì˜ˆì œ ì½”ë“œ</li>
                    <li><strong>hint</strong> - íŒíŠ¸</li>
                    <li><strong>expectedOutput</strong> - ì˜ˆìƒ ì¶œë ¥</li>
                    <li><strong>keywords</strong> - í‚¤ì›Œë“œ (ì‰¼í‘œë¡œ êµ¬ë¶„)</li>
                    <li><strong>difficulty</strong> - ë‚œì´ë„ (easy, medium, hard)</li>
                    <li><strong>order</strong> - ìˆœì„œ (ìˆ«ì)</li>
                </ol>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">
                    CSV íŒŒì¼ ì„ íƒ:
                </label>
                <input type="file" id="csv-file-input" accept=".csv" style="
                    width: 100%;
                    padding: 10px;
                    border: 2px dashed #667eea;
                    border-radius: 10px;
                    background: #f8f9fa;
                    cursor: pointer;
                ">
            </div>

            <div id="csv-preview" style="display: none; margin-bottom: 20px;">
                <h3 style="color: #667eea; margin-bottom: 10px;">ë¯¸ë¦¬ë³´ê¸°</h3>
                <div id="csv-preview-content" style="
                    max-height: 300px;
                    overflow-y: auto;
                    background: #f8f9fa;
                    padding: 15px;
                    border-radius: 10px;
                    font-size: 0.9em;
                "></div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-success" onclick="processCsvUpload()" id="upload-csv-btn" disabled>
                    ğŸ“¤ ì—…ë¡œë“œ ì‹œì‘
                </button>
                <button class="btn btn-danger" onclick="closeCsvModal()">
                    ì·¨ì†Œ
                </button>
            </div>

            <div id="csv-upload-progress" style="display: none; margin-top: 20px;">
                <div style="background: #e7f3ff; padding: 15px; border-radius: 10px;">
                    <p id="csv-progress-text" style="margin-bottom: 10px;">ì—…ë¡œë“œ ì¤‘...</p>
                    <div style="background: #ddd; height: 20px; border-radius: 10px; overflow: hidden;">
                        <div id="csv-progress-bar" style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            height: 100%;
                            width: 0%;
                            transition: width 0.3s;
                        "></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì‚­ì œ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ -->
    <div id="confirm-dialog" class="modal">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <h3 style="color: #dc3545; font-size: 1.8em; margin-bottom: 20px;">âš ï¸ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h3>
            <p id="confirm-message" style="font-size: 1.2em; margin-bottom: 30px; color: #333;"></p>
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button class="btn btn-danger" onclick="executeBulkDelete()">ì‚­ì œ</button>
                <button class="btn btn-primary" onclick="closeConfirmDialog()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
              apiKey: "AIzaSyBHOBXMqpBDsDIMONQqWZ83qxIxhU0VyG8",
              authDomain: "python-learning-system.firebaseapp.com",
              databaseURL: "https://python-learning-system-default-rtdb.asia-southeast1.firebasedatabase.app",
              projectId: "python-learning-system",
              storageBucket: "python-learning-system.firebasestorage.app",
              messagingSenderId: "844754646343",
              appId: "1:844754646343:web:da76658dae2e91d6468862",
              measurementId: "G-9Q0JVVT0QB"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let allQuestions = [];
        let currentCategory = 'all';
        let selectedQuestions = new Set();

        window.onload = function() {
            loadAllQuestions();
            const fileInput = document.getElementById('csv-file-input');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) previewCsv(file);
                });
            }
        };

        function loadAllQuestions() {
            database.ref('questions').once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    allQuestions = [];
                    
                    if (!data) {
                        document.getElementById('questions-list').innerHTML = 
                            '<p style="text-align: center; color: #666; padding: 40px;">ë“±ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                        return;
                    }
                    
                    for (let category in data) {
                        for (let qId in data[category]) {
                            allQuestions.push({
                                ...data[category][qId],
                                category: category,
                                qId: qId
                            });
                        }
                    }
                    
                    displayQuestions();
                })
                .catch((error) => {
                    console.error('ë¬¸ì œ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
                    showError('ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
        }

        function displayQuestions() {
            let questions = allQuestions;
            
            if (currentCategory !== 'all') {
                questions = allQuestions.filter(q => q.category === currentCategory);
            }
            
            if (questions.length === 0) {
                document.getElementById('questions-list').innerHTML = 
                    '<p style="text-align: center; color: #666; padding: 40px;">ì´ ì¹´í…Œê³ ë¦¬ì— ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            let html = '';
            questions.forEach(q => {
                const isSelected = selectedQuestions.has(q.qId);
                const selectedClass = isSelected ? 'selected' : '';
                const disabledClass = q.enabled === false ? 'disabled' : '';
                
                html += `
                    <div class="question-card ${selectedClass} ${disabledClass}" id="card-${q.qId}">
                        <div class="question-header">
                            <div class="question-header-left">
                                <input type="checkbox" 
                                       class="question-checkbox" 
                                       id="check-${q.qId}"
                                       ${isSelected ? 'checked' : ''}
                                       onchange="toggleQuestion('${q.qId}')">
                                <span class="question-id">${q.id || q.qId}</span>
                            </div>
                            <div class="question-actions">
                                <button class="action-btn toggle-btn" onclick="toggleQuestionStatus('${q.category}', '${q.qId}')">
                                    ${q.enabled === false ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}
                                </button>
                                <button class="action-btn delete-btn" onclick="confirmSingleDelete('${q.category}', '${q.qId}')">ì‚­ì œ</button>
                            </div>
                        </div>
                        <div class="question-text">${escapeHtml(q.question).substring(0, 150)}${q.question.length > 150 ? '...' : ''}</div>
                        <div class="question-meta">
                            <span class="meta-badge difficulty-${q.difficulty}">${getDifficultyText(q.difficulty)}</span>
                            <span class="meta-badge stats-badge">ì¹´í…Œê³ ë¦¬: ${q.category}</span>
                            <span class="meta-badge stats-badge">ìˆœì„œ: ${q.order}</span>
                            <span class="meta-badge stats-badge">ë°°ì : ${q.points}ì </span>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('questions-list').innerHTML = html;
            updateSelectedCount();
        }

        function toggleQuestion(qId) {
            if (selectedQuestions.has(qId)) {
                selectedQuestions.delete(qId);
            } else {
                selectedQuestions.add(qId);
            }
            updateQuestionCardStyle(qId);
            updateSelectedCount();
        }

        function updateQuestionCardStyle(qId) {
            const card = document.getElementById(`card-${qId}`);
            const checkbox = document.getElementById(`check-${qId}`);
            
            if (selectedQuestions.has(qId)) {
                card.classList.add('selected');
                checkbox.checked = true;
            } else {
                card.classList.remove('selected');
                checkbox.checked = false;
            }
        }

        function updateSelectedCount() {
            document.getElementById('selected-count').textContent = selectedQuestions.size;
        }

        function selectAll() {
            let questions = allQuestions;
            if (currentCategory !== 'all') {
                questions = allQuestions.filter(q => q.category === currentCategory);
            }
            
            selectedQuestions.clear();
            questions.forEach(q => {
                selectedQuestions.add(q.qId);
            });
            
            displayQuestions();
        }

        function deselectAll() {
            selectedQuestions.clear();
            displayQuestions();
        }

        function filterByCategory(category) {
            currentCategory = category;
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            displayQuestions();
        }

        function confirmBulkDelete() {
            if (selectedQuestions.size === 0) {
                showError('ì‚­ì œí•  ë¬¸ì œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            document.getElementById('confirm-message').innerHTML = 
                `ì„ íƒí•œ <strong>${selectedQuestions.size}ê°œ</strong> ë¬¸ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`;
            document.getElementById('confirm-dialog').classList.add('show');
        }

        function confirmSingleDelete(category, qId) {
            selectedQuestions.clear();
            selectedQuestions.add(qId);
            
            const question = allQuestions.find(q => q.qId === qId);
            document.getElementById('confirm-message').innerHTML = 
                `<strong>${question.id || qId}</strong> ë¬¸ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`;
            document.getElementById('confirm-dialog').classList.add('show');
        }

        function executeBulkDelete() {
            const deletePromises = [];
            
            selectedQuestions.forEach(qId => {
                const question = allQuestions.find(q => q.qId === qId);
                if (question) {
                    deletePromises.push(
                        database.ref(`questions/${question.category}/${qId}`).remove()
                    );
                }
            });
            
            Promise.all(deletePromises)
                .then(() => {
                    const count = selectedQuestions.size;
                    selectedQuestions.clear();
                    closeConfirmDialog();
                    showSuccess(`${count}ê°œ ë¬¸ì œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    loadAllQuestions();
                })
                .catch(error => {
                    console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
                    showError('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    closeConfirmDialog();
                });
        }

        function closeConfirmDialog() {
            document.getElementById('confirm-dialog').classList.remove('show');
        }

        function toggleQuestionStatus(category, qId) {
            const question = allQuestions.find(q => q.qId === qId);
            const newStatus = !(question.enabled === false);
            
            database.ref(`questions/${category}/${qId}/enabled`).set(newStatus)
                .then(() => {
                    showSuccess(newStatus ? 'ë¬¸ì œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ë¬¸ì œê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadAllQuestions();
                })
                .catch(error => {
                    console.error('ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜:', error);
                    showError('ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
        }

        // CSV ê´€ë ¨ í•¨ìˆ˜
        function openCsvModal() {
            document.getElementById('csv-modal').classList.add('show');
        }

        function closeCsvModal() {
            document.getElementById('csv-modal').classList.remove('show');
            document.getElementById('csv-file-input').value = '';
            document.getElementById('csv-preview').style.display = 'none';
            document.getElementById('upload-csv-btn').disabled = true;
        }

        function previewCsv(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    showError('CSV íŒŒì¼ì´ ë¹„ì–´ìˆê±°ë‚˜ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const headers = parseCSVLine(lines[0]);
                const requiredHeaders = ['category', 'question', 'example', 'hint', 'expectedOutput', 'keywords', 'difficulty', 'order'];
                const hasAllHeaders = requiredHeaders.every(h => headers.includes(h));
                
                if (!hasAllHeaders) {
                    showError('CSV í—¤ë”ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. í•„ìˆ˜ ì»¬ëŸ¼: ' + requiredHeaders.join(', '));
                    return;
                }
                
                let preview = `<strong>ì´ ${lines.length - 1}ê°œ ë¬¸ì œ</strong><br><br>`;
                preview += '<table style="width: 100%; border-collapse: collapse;">';
                preview += '<tr style="background: #667eea; color: white;">';
                headers.forEach(h => {
                    preview += `<th style="padding: 8px; text-align: left; border: 1px solid #ddd;">${h}</th>`;
                });
                preview += '</tr>';
                
                for (let i = 1; i < Math.min(6, lines.length); i++) {
                    const cells = parseCSVLine(lines[i]);
                    preview += '<tr>';
                    cells.forEach(cell => {
                        const displayText = cell.length > 30 ? cell.substring(0, 30) + '...' : cell;
                        preview += `<td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(displayText)}</td>`;
                    });
                    preview += '</tr>';
                }
                
                if (lines.length > 6) {
                    preview += `<tr><td colspan="${headers.length}" style="padding: 8px; text-align: center; color: #666;">... ì™¸ ${lines.length - 6}ê°œ ë¬¸ì œ</td></tr>`;
                }
                
                preview += '</table>';
                
                document.getElementById('csv-preview-content').innerHTML = preview;
                document.getElementById('csv-preview').style.display = 'block';
                document.getElementById('upload-csv-btn').disabled = false;
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        function processCsvUpload() {
            const fileInput = document.getElementById('csv-file-input');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            document.getElementById('csv-upload-progress').style.display = 'block';
            document.getElementById('upload-csv-btn').disabled = true;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim());
                
                const headers = parseCSVLine(lines[0]);
                const categoryIndex = headers.indexOf('category');
                const questionIndex = headers.indexOf('question');
                const exampleIndex = headers.indexOf('example');
                const hintIndex = headers.indexOf('hint');
                const expectedOutputIndex = headers.indexOf('expectedOutput');
                const keywordsIndex = headers.indexOf('keywords');
                const difficultyIndex = headers.indexOf('difficulty');
                const orderIndex = headers.indexOf('order');
                
                const questions = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const cells = parseCSVLine(lines[i]);
                    
                    if (cells.length < 8) continue;
                    
                    questions.push({
                        category: cells[categoryIndex],
                        question: cells[questionIndex],
                        example: cells[exampleIndex].replace(/\\n/g, '\n'),
                        hint: cells[hintIndex],
                        expectedOutput: cells[expectedOutputIndex],
                        keywords: cells[keywordsIndex].split(',').map(k => k.trim()),
                        difficulty: cells[difficultyIndex],
                        order: parseInt(cells[orderIndex]) || i
                    });
                }
                
                uploadQuestionsToFirebase(questions);
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        function uploadQuestionsToFirebase(questions) {
            let uploaded = 0;
            const total = questions.length;
            
            const categoryCount = {};
            
            questions.forEach((q, index) => {
                if (!categoryCount[q.category]) {
                    categoryCount[q.category] = 0;
                }
                categoryCount[q.category]++;
                
                const qId = `Q${q.category.substring(0, 3).toUpperCase()}${String(categoryCount[q.category]).padStart(3, '0')}`;
                
                const questionData = {
                    id: qId,
                    question: q.question,
                    example: q.example,
                    hint: q.hint,
                    expectedOutput: q.expectedOutput,
                    keywords: q.keywords,
                    difficulty: q.difficulty,
                    points: q.difficulty === 'easy' ? 100 : q.difficulty === 'medium' ? 150 : 200,
                    order: q.order,
                    enabled: true,
                    category: q.category,
                    createdAt: Date.now()
                };
                
                database.ref(`questions/${q.category}/${qId}`).set(questionData)
                    .then(() => {
                        uploaded++;
                        const progress = Math.round((uploaded / total) * 100);
                        document.getElementById('csv-progress-bar').style.width = progress + '%';
                        document.getElementById('csv-progress-text').textContent = 
                            `ì—…ë¡œë“œ ì¤‘... ${uploaded} / ${total} (${progress}%)`;
                        
                        if (uploaded === total) {
                            setTimeout(() => {
                                showSuccess(`${total}ê°œ ë¬¸ì œê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!`);
                                closeCsvModal();
                                loadAllQuestions();
                            }, 500);
                        }
                    })
                    .catch(error => {
                        console.error('ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                        showError('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    });
            });
        }

        function getDifficultyText(difficulty) {
            const map = { 'easy': 'ì‰¬ì›€', 'medium': 'ë³´í†µ', 'hard': 'ì–´ë ¤ì›€' };
            return map[difficulty] || difficulty;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showSuccess(message) {
            const el = document.getElementById('success-message');
            el.textContent = message;
            el.classList.add('show');
            setTimeout(() => { el.classList.remove('show'); }, 3000);
        }

        function showError(message) {
            const el = document.getElementById('error-message');
            el.textContent = message;
            el.classList.add('show');
            setTimeout(() => { el.classList.remove('show'); }, 3000);
        }
    </script>
</body>
</html>
